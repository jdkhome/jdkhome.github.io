(window.webpackJsonp=window.webpackJsonp||[]).push([[82],{490:function(s,a,t){"use strict";t.r(a);var e=t(30),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"kvm简单使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#kvm简单使用"}},[s._v("#")]),s._v(" KVM简单使用")]),s._v(" "),t("p",[s._v("需求：在一台配置不错的机器上安装kvm，然后开小虚拟机，小虚拟机拥有局域网ip地址")]),s._v(" "),t("h2",{attrs:{id:"首先是宿主机安装kvm"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#首先是宿主机安装kvm"}},[s._v("#")]),s._v(" 首先是宿主机安装kvm")]),s._v(" "),t("p",[s._v("下面操作均是切换至root用户进行的。")]),s._v(" "),t("h3",{attrs:{id:"检查cpu是否支持虚拟化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#检查cpu是否支持虚拟化"}},[s._v("#")]),s._v(" 检查cpu是否支持虚拟化")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("egrep -c '(svm|vmx)' /proc/cpuinfo\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("上面命令执行结果如果返回0，表示CPU不支持虚拟化技术。当然主板BIOS中的虚拟化技术也可能不是默认开启的，如果没有开启需要手动开启一下。")]),s._v(" "),t("h3",{attrs:{id:"安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[s._v("#")]),s._v(" 安装")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("apt update\napt install qemu qemu-kvm libvirt-bin bridge-utils virt-manager\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("将libvirtd添加自启动")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("systemctl start libvirtd.service\nsystemctl enable libvirtd.service\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h3",{attrs:{id:"配置桥接"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置桥接"}},[s._v("#")]),s._v(" 配置桥接")]),s._v(" "),t("p",[s._v("kvm支持多种网络模式，比如NAT、桥接。")]),s._v(" "),t("p",[s._v("NAT是默认的网络模式，KVM会创建一个名为virbr0的虚拟网桥，然后在这个网桥上给虚拟机分配自己的内网ip。(相当于内部组了一个局域网)\nNAT模式，外网是无法访问虚拟机的。")]),s._v(" "),t("p",[s._v("桥接模式，用一个新网桥来接管宿主机网卡对应的外部网络，然后让宿主机和虚拟机都通过这个网桥来访问外部网络，大家都能拿到外部网络的ip。")]),s._v(" "),t("p",[s._v("首先查看宿主机的网卡")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("ip addr\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("找到绑定了局域网ip的那个网卡，我的是enp12s0")]),s._v(" "),t("p",[s._v("然后修改netplan配置")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("cat /etc/netplan/50-cloud-init.yaml \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("network")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ethernets")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("enp12s0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dhcp4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" no\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("optional")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nameservers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("addresses")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("192.168.1.1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("114.114.114.114"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("8.8.8.8"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("bridges")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("br0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("interfaces")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("enp12s0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dhcp4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" no\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("addresses")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("192.168.1.54/24"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("gateway4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 192.168.1.1\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nameservers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("addresses")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("192.168.1.1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("114.114.114.114"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("8.8.8.8"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("p",[s._v("这里我的宿主机局域网ip是 192.168.1.54 然后网关(路由器)的ip是 192.168.1.1")]),s._v(" "),t("h3",{attrs:{id:"防火墙配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#防火墙配置"}},[s._v("#")]),s._v(" 防火墙配置")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('vim /etc/default/ufw\n\n# ... 省略\nDEFAULT_FORWARD_POLICY="ACCEPT"\n# ... 省略\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("重启ufw服务让设置生效")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("systemctl restart ufw.service\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("iptable设一下")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("iptables -A FORWARD -j ACCEPT\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("至此kvm的宿主机设置就完成了")]),s._v(" "),t("h2",{attrs:{id:"启动虚拟机"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#启动虚拟机"}},[s._v("#")]),s._v(" 启动虚拟机")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('virt-install \\\n-n ubuntu18.04-template \\\n--description "ubuntu18.04-template" \\\n--accelerate \\\n--ram=8192 --vcpus=2 \\\n--network bridge:br0 \\\n--graphics vnc,listen=0.0.0.0,keymap=en-us \\\n--os-type=linux --os-variant=ubuntu18.04 \\\n--disk path=/hdd-data/img/ubuntu18.04-template.img,bus=virtio,size=40 \\\n--cdrom /ssd-data/iso/ubuntu-18.04.4-live-server-amd64.iso\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("这个os-variant参数可以参考http://www.linuxcoming.com/blog/2019/09/03/linux_basic_tools_virt_install_os_variant.html")]),s._v(" "),t("p",[s._v("启动之后，需要通过vnc连接虚拟机以完成安装。这个地方建议多开一个终端，因为安装完成之前这个终端的命令输入是阻塞的。")]),s._v(" "),t("p",[s._v("查看vnc端口:")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("virsh vncdisplay 虚拟机名称\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("vnc的端口是从5900开始的 所以这个命令返回的数字+5900就是具体的端口号")]),s._v(" "),t("h3",{attrs:{id:"克隆虚拟机"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#克隆虚拟机"}},[s._v("#")]),s._v(" 克隆虚拟机")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("virt-clone \\\n-o ubuntu18.04-template \\\n-n ubuntu-jdk001 \\\n-f /hdd-data/img/ubuntu-jdk001.img \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h2",{attrs:{id:"连接到虚拟机"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#连接到虚拟机"}},[s._v("#")]),s._v(" 连接到虚拟机")]),s._v(" "),t("p",[s._v("因为虚拟机有局域网ip，所以可以用ssh连接虚拟机，不过如果是刚复制出来的虚拟机，我们并不能直接得到它的ip地址，用arp也不行。")]),s._v(" "),t("p",[s._v("此时有2种方法:")]),s._v(" "),t("ul",[t("li",[s._v("vnc连上去，然后看ip")]),s._v(" "),t("li",[s._v("virsh console 命令")])]),s._v(" "),t("p",[s._v("这里说下virsh console，因为比较方便")]),s._v(" "),t("p",[s._v("首先是用于复制的模版虚拟机需要执行以下命令来开启访问服务：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("sudo systemctl enable serial-getty@ttyS0.service\nsudo systemctl start serial-getty@ttyS0.service\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("宿主机访问虚拟机")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("virsh console 虚拟机名称\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("执行之后要按一下回车才会提示登陆")]),s._v(" "),t("p",[s._v("然后是按ctrl+] 退出访问")]),s._v(" "),t("h2",{attrs:{id:"安装windows10虚拟机"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装windows10虚拟机"}},[s._v("#")]),s._v(" 安装windows10虚拟机")]),s._v(" "),t("p",[s._v("安装Windows 10虚拟机会出现没有virtio驱动的问题，导致安装程序找不到硬盘，需要先下载virtio驱动。")]),s._v(" "),t("p",[s._v("https://docs.fedoraproject.org/en-US/quick-docs/creating-windows-virtual-machines-using-virtio-drivers/index.html")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('virt-install \\\n-n win10-1909-template \\\n--description "win10-1909-template" \\\n--accelerate \\\n--ram=8192 --vcpus=2 \\\n--network bridge:br0 \\\n--graphics vnc,listen=0.0.0.0,keymap=en-us \\\n--os-type=win --os-variant=win10 \\\n--disk path=/hdd-data/img/win10-1909-template.img,bus=virtio,size=60 \\\n--disk path=/ssd-data/iso/virtio-win-0.1.171_amd64.vfd,device=floppy \\\n--cdrom=/ssd-data/iso/win10-1909-x64.iso\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("p",[s._v("安装时会找不到硬盘，这时候选择加载驱动，然后选择加载软盘里的驱动就可以了")]),s._v(" "),t("h2",{attrs:{id:"虚拟机管理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#虚拟机管理"}},[s._v("#")]),s._v(" 虚拟机管理")]),s._v(" "),t("h3",{attrs:{id:"查看虚拟机"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看虚拟机"}},[s._v("#")]),s._v(" 查看虚拟机")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("virsh list\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"虚拟机关机-拔电源"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#虚拟机关机-拔电源"}},[s._v("#")]),s._v(" 虚拟机关机(拔电源)")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("virsh destroy 虚拟机名称\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"删除虚拟机"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#删除虚拟机"}},[s._v("#")]),s._v(" 删除虚拟机")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("virsh undefine 虚拟机名称\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("还需要手动删除虚拟机的img文件")]),s._v(" "),t("h2",{attrs:{id:"参考资料"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[s._v("#")]),s._v(" 参考资料")]),s._v(" "),t("ul",[t("li",[s._v("https://segmentfault.com/a/1190000015418876")])])])}),[],!1,null,null,null);a.default=n.exports}}]);