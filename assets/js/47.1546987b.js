(window.webpackJsonp=window.webpackJsonp||[]).push([[47],{456:function(s,a,t){"use strict";t.r(a);var e=t(30),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"kubernetes-启动pod-遇到-crashloopbackoff-解决方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes-启动pod-遇到-crashloopbackoff-解决方案"}},[s._v("#")]),s._v(" Kubernetes 启动Pod 遇到 CrashLoopBackOff 解决方案")]),s._v(" "),t("h2",{attrs:{id:"简述"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#简述"}},[s._v("#")]),s._v(" 简述")]),s._v(" "),t("p",[s._v("CrashLoopBackOff 的含义是:")]),s._v(" "),t("blockquote",[t("p",[s._v("Kubernetes试图启动该Pod, 但是过程中出现错误, 导致容器启动失败或者正在被删除。")])]),s._v(" "),t("p",[s._v("遇到这个问题, 必须得就事论事, 没有统一的解决方案。但是要说思路, 那无非就是看日志, 修改, 尝试启动, 再看日志.")]),s._v(" "),t("h2",{attrs:{id:"实例-elk服务出现-crashloopbackoff"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实例-elk服务出现-crashloopbackoff"}},[s._v("#")]),s._v(" 实例 elk服务出现 CrashLoopBackOff")]),s._v(" "),t("p",[s._v("我在搭建elk时, elk的Pod 一直处于 CrashLoopBackOff.")]),s._v(" "),t("h3",{attrs:{id:"登录master获取pod状态"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#登录master获取pod状态"}},[s._v("#")]),s._v(" 登录master获取pod状态")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("ubuntu@master:~/my-study-data/elk$ kubectl get pod\nNAME                                READY   STATUS             RESTARTS   AGE\nelk-deployment-788969848c-84j6q     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/1     CrashLoopBackOff   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("          16m\nnginx-deployment-54f57cf6bf-5zqlx   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running            "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          16h\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h3",{attrs:{id:"查看异常pod的详细详细"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看异常pod的详细详细"}},[s._v("#")]),s._v(" 查看异常pod的详细详细")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("ubuntu@master:~/my-study-data/elk$ kubectl describe pod elk-deployment-788969848c-84j6q\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ... 省略 ...")]),s._v("\nNode:         worker2/192.168.12.77\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ... 省略 ...")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h3",{attrs:{id:"查看pod的日志"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看pod的日志"}},[s._v("#")]),s._v(" 查看pod的日志")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("ubuntu@master:~/my-study-data/elk$ kubectl logs elk-deployment-788969848c-84j6q\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ... 省略 ...")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": max virtual memory areas vm.max_map_count "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("65530")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" is too low, increase to at least "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("262144")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ... 省略 ...")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("这就找到了起不起来的原因")]),s._v(" "),t("h3",{attrs:{id:"解决"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#解决"}},[s._v("#")]),s._v(" 解决")]),s._v(" "),t("p",[t("strong",[s._v("vm.max_map_count")]),s._v("参数，是允许一个进程在VMAs拥有最大数量（VMA：虚拟内存地址， 一个连续的虚拟地址空间），当进程占用内存超过时， 直接OOM。")]),s._v(" "),t("p",[s._v("elasticsearch占用内存较高。官方要求max_map_count需要配置到最小262144。")]),s._v(" "),t("p",[s._v("max_map_count配置文件写在系统的**/proc/sys/vm**中")]),s._v(" "),t("p",[s._v("前面使用 "),t("strong",[s._v("describe")]),s._v(" 已经知道, elk的Pod现在是在 "),t("strong",[s._v("worker2/192.168.12.77")])]),s._v(" "),t("p",[s._v("那么我们进到worker2机器")]),s._v(" "),t("p",[s._v("通过 "),t("strong",[s._v("docker inspect")]),s._v(" 命令, 可查看docker使用宿主机的/proc/sys作为只读路径之一。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("ubuntu@worker2:~$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" docker inspect 8ad12516c611\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ... 省略 ...")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ReadonlyPaths"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/proc/bus"')]),s._v(",\n                "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/proc/fs"')]),s._v(",\n                "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/proc/irq"')]),s._v(",\n                "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/proc/sys"')]),s._v(",\n                "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/proc/sysrq-trigger"')]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ... 省略 ...")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("说明镜像使用宿主机的max_map_count参数。因此直接修改宿主机的max_map_count参数即可。")]),s._v(" "),t("p",[s._v("查看 max_map_count 值:")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("ubuntu@worker2:~$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("more")]),s._v(" /proc/sys/vm/max_map_count\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("65530")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("修改有2种方法:")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("sudo sysctl -w vm.max_map_count=262144\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("但是这种方法, 机器重启后会失效。")]),s._v(" "),t("p",[s._v("永久修改:")]),s._v(" "),t("p",[s._v("在 /etc/sysctl.conf  文件最后添加一行")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("vm.max_map_count=262144\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("然后执行")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("sudo sysctl -p\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("补充")]),s._v(" "),t("blockquote",[t("p",[s._v("要么在Kubernets 把elk的Pod部署在固定的Node, 要么修改所有Node的vm.max_map_count。 我选择了前者，见"),t("RouterLink",{attrs:{to:"/30.Kubernetes/kubernetes-assigning-pod-to-nodes.html"}},[s._v("分配pod到指定的节点")]),s._v("。")],1)])])}),[],!1,null,null,null);a.default=n.exports}}]);