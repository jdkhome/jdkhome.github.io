(window.webpackJsonp=window.webpackJsonp||[]).push([[44],{453:function(s,e,a){"use strict";a.r(e);var t=a(30),n=Object(t.a)({},(function(){var s=this,e=s.$createElement,a=s._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"国内环境-ubuntu18-安装-k8s"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#国内环境-ubuntu18-安装-k8s"}},[s._v("#")]),s._v(" 国内环境 ubuntu18 安装 k8s")]),s._v(" "),a("h2",{attrs:{id:"环境准备"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#环境准备"}},[s._v("#")]),s._v(" 环境准备")]),s._v(" "),a("p",[s._v("准备了三台ubuntu18 虚拟机")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("IP")]),s._v(" "),a("th",[s._v("ROTE")]),s._v(" "),a("th",[s._v("Hostname")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("192.168.12.98")]),s._v(" "),a("td",[s._v("master")]),s._v(" "),a("td",[s._v("master")])]),s._v(" "),a("tr",[a("td",[s._v("192.168.12.122")]),s._v(" "),a("td",[s._v("worker")]),s._v(" "),a("td",[s._v("worker1")])]),s._v(" "),a("tr",[a("td",[s._v("192.168.12.94")]),s._v(" "),a("td",[s._v("worker")]),s._v(" "),a("td",[s._v("worker2")])])])]),s._v(" "),a("h3",{attrs:{id:"设置主机名"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#设置主机名"}},[s._v("#")]),s._v(" 设置主机名")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# 设置主机名\nsudo hostnamectl set-hostname master\n\n# host 添加一行 \nsudo vim /etc/hosts\n127.0.0.1 master\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("其他节点照着改名字即可")]),s._v(" "),a("h2",{attrs:{id:"关闭swap"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#关闭swap"}},[s._v("#")]),s._v(" 关闭swap")]),s._v(" "),a("p",[s._v("see "),a("RouterLink",{attrs:{to:"/30.Kubernetes/linux-close-swap.html"}},[s._v("linux 关闭交换空间")])],1),s._v(" "),a("h3",{attrs:{id:"关闭-selinux"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#关闭-selinux"}},[s._v("#")]),s._v(" 关闭 SeLinux")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('setenforce 0\nsed -i "s/SELINUX=enforcing/SELINUX=disabled/g" /etc/selinux/config\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h3",{attrs:{id:"master-额外执行下面命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#master-额外执行下面命令"}},[s._v("#")]),s._v(" Master 额外执行下面命令")]),s._v(" "),a("p",[s._v("创建/etc/sysctl.d/k8s.conf文件，添加如下内容")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("sudo vim /etc/sysctl.d/k8s.conf\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\nnet.ipv4.ip_forward = 1\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("执行命令使修改生效")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("sudo modprobe br_netfilter\nsudo sysctl -p /etc/sysctl.d/k8s.conf\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h2",{attrs:{id:"安装docker"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装docker"}},[s._v("#")]),s._v(" 安装docker")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("sudo apt  install docker.io -y\nsystemctl enable docker.service\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h2",{attrs:{id:"安装-kubeadm-kubelet-kubectl"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装-kubeadm-kubelet-kubectl"}},[s._v("#")]),s._v(" 安装 kubeadm, kubelet, kubectl")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("sudo apt-get update && sudo apt-get install -y apt-transport-https\n\nsudo curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add -\n\nsudo cat <<EOF >/etc/apt/sources.list.d/kubernetes.list\ndeb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main\nEOF\n\nsudo apt-get update\nsudo apt-get install -y kubelet=1.19.1-00 kubeadm=1.19.1-00 kubectl\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("h2",{attrs:{id:"准备镜像"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#准备镜像"}},[s._v("#")]),s._v(" 准备镜像")]),s._v(" "),a("p",[s._v("这一步 可以说是最容易失败的步骤了, 简述一下原因:")]),s._v(" "),a("ol",[a("li",[s._v("kubeadm init 时要拉取 镜像仓库k8s.gcr.io下的镜像")]),s._v(" "),a("li",[s._v("国内无法访问k8s.gcr.io")]),s._v(" "),a("li",[s._v("为了kubeadm init能够正常执行, 我们要提前先准备好要pull的k8s.gcr.io下的镜像")])]),s._v(" "),a("p",[s._v("这里我已经准备好了k8s 1.19.1所需的镜像，只需拉下来打tag即可")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# 查看需要的镜像\nkubeadm config images list\n\n# 拉取镜像\ndocker pull jdkhome/kube-apiserver:v1.19.1\ndocker pull jdkhome/kube-controller-manager:v1.19.1\ndocker pull jdkhome/kube-scheduler:v1.19.1\ndocker pull jdkhome/kube-proxy:v1.19.1\ndocker pull jdkhome/pause:3.2\ndocker pull jdkhome/etcd:3.4.13-0\ndocker pull jdkhome/coredns:1.7.0\n\n# 修改镜像名称\ndocker tag jdkhome/kube-apiserver:v1.19.1 k8s.gcr.io/kube-apiserver:v1.19.1\ndocker tag jdkhome/kube-controller-manager:v1.19.1 k8s.gcr.io/kube-controller-manager:v1.19.1\ndocker tag jdkhome/kube-scheduler:v1.19.1 k8s.gcr.io/kube-scheduler:v1.19.1\ndocker tag jdkhome/kube-proxy:v1.19.1 k8s.gcr.io/kube-proxy:v1.19.1\ndocker tag jdkhome/pause:3.2 k8s.gcr.io/pause:3.2\ndocker tag jdkhome/etcd:3.4.13-0 k8s.gcr.io/etcd:3.4.13-0\ndocker tag jdkhome/coredns:1.7.0 k8s.gcr.io/coredns:1.7.0\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("h2",{attrs:{id:"初始化master"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#初始化master"}},[s._v("#")]),s._v(" 初始化Master")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("sudo kubeadm init --pod-network-cidr=10.244.0.0/16\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("执行完成后就完成了Kubernetes Master的部署了, 最后还打印出加入Worker加入Master的命令, 需要找个地方记下来。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("sudo kubeadm join 192.168.12.98:6443 --token tearz2.rvquwsv5gd7ds8tn \\\n    --discovery-token-ca-cert-hash sha256:dd0674653ecc31f204a8f81d0eb91a14664a005fb05a61f56532fd977f14c7a4 \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("如果不小心忘记了，可以执行")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("kubeadm token create --print-join-command --ttl 0\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("另外, kubeadm 还会提示我们第一次使用 Kubernetes 集群所需要的配置命令:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("mkdir -p $HOME/.kube\nsudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\nsudo chown $(id -u):$(id -g) $HOME/.kube/config\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("而需要这些配置命令的原因是: Kubernetes 集群默认需要加密方式访问。所以，这几条命令，就是将刚刚部署生成的 Kubernetes 集群的安全配置文件，保存到当前用户的.kube 目录下，\nkubectl 默认会使用这个目录下的授权信息访问 Kubernetes 集群。")]),s._v(" "),a("h3",{attrs:{id:"部署网络插件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署网络插件"}},[s._v("#")]),s._v(" 部署网络插件")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("kubectl apply -f \"https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\\n')\"\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("查看pod状态")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("kubectl get pods -n kube-system\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"部署worker节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署worker节点"}},[s._v("#")]),s._v(" 部署Worker节点")]),s._v(" "),a("p",[s._v("准备镜像完成后, 执行前面打印的 kubeadm join 命令即可")]),s._v(" "),a("p",[s._v("在master 执行")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("kubectl get nodes\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("可以看到节点情况，舒服~。")]),s._v(" "),a("h2",{attrs:{id:"参考资料"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[s._v("#")]),s._v(" 参考资料")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://www.cnblogs.com/chenzhenqi/p/10695959.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("使用 kubeadm 安装 kubernetes v1.16.0"),a("OutboundLink")],1),s._v(" eastonliu")]),s._v(" "),a("li",[a("a",{attrs:{href:"https://www.cnblogs.com/eastonliu/p/11637929.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("国内环境安装k8s"),a("OutboundLink")],1),s._v(" chenzhenqi")])]),s._v(" "),a("p",[s._v("Enjoy~")])])}),[],!1,null,null,null);e.default=n.exports}}]);