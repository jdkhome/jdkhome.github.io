(window.webpackJsonp=window.webpackJsonp||[]).push([[54],{463:function(s,a,t){"use strict";t.r(a);var n=t(30),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"搭建k8s高可用集群"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#搭建k8s高可用集群"}},[s._v("#")]),s._v(" 搭建k8s高可用集群")]),s._v(" "),t("h2",{attrs:{id:"前言"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),t("p",[s._v("前面在"),t("RouterLink",{attrs:{to:"/pages/0da669/"}},[s._v("国内环境 ubuntu18 安装 k8s")]),s._v("这篇文章中，我们搭建了简单的单master的k8s集群，但是在生产环境中，单节点是无法满足高可用的需求的。本篇文章将指导搭建一个3master、3worker的高可用k8s集群。")],1),s._v(" "),t("h3",{attrs:{id:"准备工作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#准备工作"}},[s._v("#")]),s._v(" 准备工作")]),s._v(" "),t("p",[s._v("7台机器")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("IP")]),s._v(" "),t("th",[s._v("ROTE")]),s._v(" "),t("th",[s._v("Hostname")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("10.0.0.180")]),s._v(" "),t("td",[s._v("负载均衡器")]),s._v(" "),t("td",[s._v("k8slb")])]),s._v(" "),t("tr",[t("td",[s._v("10.0.0.181")]),s._v(" "),t("td",[s._v("master")]),s._v(" "),t("td",[s._v("master001")])]),s._v(" "),t("tr",[t("td",[s._v("10.0.0.182")]),s._v(" "),t("td",[s._v("master")]),s._v(" "),t("td",[s._v("master002")])]),s._v(" "),t("tr",[t("td",[s._v("10.0.0.183")]),s._v(" "),t("td",[s._v("master")]),s._v(" "),t("td",[s._v("master003")])]),s._v(" "),t("tr",[t("td",[s._v("10.0.0.185")]),s._v(" "),t("td",[s._v("worker")]),s._v(" "),t("td",[s._v("worker001")])]),s._v(" "),t("tr",[t("td",[s._v("10.0.0.186")]),s._v(" "),t("td",[s._v("worker")]),s._v(" "),t("td",[s._v("worker002")])]),s._v(" "),t("tr",[t("td",[s._v("10.0.0.187")]),s._v(" "),t("td",[s._v("worker")]),s._v(" "),t("td",[s._v("worker003")])])])]),s._v(" "),t("p",[s._v("这里除了k8s的node之外，还需要准备一个负载均衡器，我这里直接单开一台机器来安装负载均衡器，如果你是云上环境，可以直接用云服务商提供的负载均衡能力。")]),s._v(" "),t("p",[s._v("所有机器都安装好docker、设置好hostname。除了负载均衡器所在机器外，其他机器全部安装好kubeadm、kubelet、kubectl 并准备好启动k8s时所需的镜像。如有疑问可以参考"),t("RouterLink",{attrs:{to:"/pages/0da669/"}},[s._v("国内环境 ubuntu18 安装 k8s")]),s._v("。")],1),s._v(" "),t("h2",{attrs:{id:"准备负载均衡器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#准备负载均衡器"}},[s._v("#")]),s._v(" 准备负载均衡器")]),s._v(" "),t("p",[s._v("这里的负载均衡器是用来对k8s的 apiserver进行负载均衡的，官方没有限制负载均衡的软件，我这里用的是haproxy。 你可以进一步的搭建出haproxy + keepalive 的高可用负载均衡。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /data/haproxy/haproxy.cfg ")]),s._v("\nglobal\n    daemon\n    nbproc "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chroot")]),s._v(" /usr/local/etc/haproxy\n\ndefaults\n    mode tcp\n    retries "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n    option redispatch\n    maxconn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" connect 5000ms\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" client 30000ms\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" server 30000ms\n    log "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 local0 err\n\nlisten apiserver\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("bind")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0:6443\n    mode tcp\n    server master001 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v(".0.181:6443 check\n    server master002 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v(".0.182:6443 check\n    server master003 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v(".0.183:6443 check\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动haproxy容器")]),s._v("\ndocker run -d "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--name haproxy "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--restart"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("always "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n-p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6443")]),s._v(":6443 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n-v /data/haproxy:/usr/local/etc/haproxy:ro "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\nhaproxy:2.2.3\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br")])]),t("h2",{attrs:{id:"启动"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#启动"}},[s._v("#")]),s._v(" 启动")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("kubeadm init --control-plane-endpoint "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v(".0.180:6443 --upload-certs\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("初始化完成后终端上会打印出相应的join命令")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 加入成为master")]),s._v("\nkubeadm "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v(".0.180:6443 --token xxxxxxx "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n\t--discovery-token-ca-cert-hash sha256:xxxxxxx "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --control-plane --certificate-key xxxxxxx\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 加入成为worker")]),s._v("\nkubeadm "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v(".0.180:6443 --token xxxxxxx "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --discovery-token-ca-cert-hash sha256:xxxxxxx\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("可见加入成为master相较加入成为worker 只是多了一个 certificate-key 的参数。")]),s._v(" "),t("p",[s._v("在其他的node上使用root权限执行命令即可加入。")]),s._v(" "),t("p",[s._v("最后的效果：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ kubectl get nodes\nNAME        STATUS     ROLES    AGE     VERSION\nmaster001   Ready      master   82m     v1.19.1\nmaster002   Ready      master   78m     v1.19.1\nmaster003   Ready      master   25m     v1.19.1\nworker001   Ready      "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("   16m     v1.19.1\nworker002   Ready      "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("   16m     v1.19.1\nworker003   Ready      "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("   2m22s   v1.19.1\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("h2",{attrs:{id:"补充"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#补充"}},[s._v("#")]),s._v(" 补充")]),s._v(" "),t("p",[s._v("如果忘记了join的命令，可以用以下方式重新生成：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 生成加入成为worker的命令")]),s._v("\nkubeadm token create --print-join-command --ttl "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 生成加入成为master的 certificate-key 值")]),s._v("\nkubeadm init phase upload-certs --upload-certs\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h2",{attrs:{id:"参考链接"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考链接"}},[s._v("#")]),s._v(" 参考链接")]),s._v(" "),t("p",[s._v("https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/high-availability/")])])}),[],!1,null,null,null);a.default=e.exports}}]);